% --- Facts ---

% movie(Name, Director, Actors, Genre, Language, AgeRating, Year, IMDBrate, LeadGender, Duration, AwardsWon).
movie('The Shawshank Redemption', 'Frank Darabont', ['Tim Robbins', 'Morgan Freeman'], ['Drama', 'Crime'], 'English', 'R', 1994, 9.3, 'Male', 142, 21).
movie('Schindler\'s List', 'Steven Spielberg', ['Liam Neeson', 'Ben Kingsley'], ['Biography', 'History'], 'English', 'R', 1993, 8.9, 'Male', 195, 91).
movie('Forrest Gump', 'Robert Zemeckis', ['Tom Hanks', 'Robin Wright'], ['Drama', 'Comedy'], 'English', 'PG-13', 1994, 8.8, 'Male', 142, 51).
movie('Inception', 'Christopher Nolan', ['Leonardo DiCaprio', 'Joseph Gordon-Levitt'], ['Action', 'Sci-Fi'], 'English', 'PG-13', 2010, 8.8, 'Male', 148, 159).
movie('Fight Club', 'David Fincher', ['Brad Pitt', 'Edward Norton'], ['Drama', 'Thriller'], 'English', 'R', 1999, 8.8, 'Male', 139, 12).
movie('The Matrix', 'Lana Wachowski', ['Keanu Reeves', 'Laurence Fishburne'], ['Action', 'Sci-Fi'], 'English', 'R', 1999, 8.7, 'Male', 136, 42).
movie('Goodfellas', 'Martin Scorsese', ['Ray Liotta', 'Robert De Niro'], ['Crime', 'Biography'], 'English', 'R', 1990, 8.7, 'Male', 146, 44).
movie('Saving Private Ryan', 'Steven Spielberg', ['Tom Hanks', 'Matt Damon'], ['Drama', 'War'], 'English', 'R', 1998, 8.6, 'Male', 169, 79).
movie('The Usual Suspects', 'Bryan Singer', ['Kevin Spacey', 'Gabriel Byrne'], ['Crime', 'Mystery'], 'English', 'R', 1995, 8.5, 'Male', 106, 37).
movie('Se7en', 'David Fincher', ['Morgan Freeman', 'Brad Pitt'], ['Crime', 'Thriller'], 'English', 'R', 1995, 8.6, 'Male', 127, 39).
movie('Interstellar', 'Christopher Nolan', ['Matthew McConaughey', 'Anne Hathaway'], ['Adventure', 'Sci-Fi'], 'English', 'PG-13', 2014, 8.6, 'Male', 169, 44).
movie('The Departed', 'Martin Scorsese', ['Leonardo DiCaprio', 'Matt Damon'], ['Crime', 'Thriller'], 'English', 'R', 2006, 8.5, 'Male', 151, 100).
movie('The Prestige', 'Christopher Nolan', ['Hugh Jackman', 'Christian Bale'], ['Drama', 'Mystery'], 'English', 'PG-13', 2006, 8.5, 'Male', 130, 6).
movie('The Lion King', 'Roger Allers', ['Matthew Broderick', 'James Earl Jones'], ['Animation', 'Adventure'], 'English', 'G', 1994, 8.5, 'Both', 88, 43).
movie('Django Unchained', 'Quentin Tarantino', ['Jamie Foxx', 'Christoph Waltz'], ['Western', 'Drama'], 'English', 'R', 2012, 8.4, 'Male', 165, 58).
movie('Collateral', 'Michael Mann', ['Tom Cruise', 'Jamie Foxx'], ['Action', 'Thriller'], 'English', 'R', 2004, 7.5, 'Male', 120, 22).
movie('Edge of Tomorrow', 'Doug Liman', ['Tom Cruise', 'Emily Blunt'], ['Action', 'Sci-Fi'], 'English', 'PG-13', 2014, 7.9, 'Male', 113, 11).
movie('Wall-E', 'Andrew Stanton', ['Ben Burtt', 'Elissa Knight'], ['Animation', 'Adventure'], 'English', 'G', 2008, 8.4, 'Both', 98, 96).
movie('Your Name', 'Makoto Shinkai', ['Ryunosuke Kamiki', 'Mone Kamishiraishi'], ['Animation', 'Romance'], 'Japanese', 'PG', 2016, 8.9, 'Both', 106, 17).
movie('Spirited Away', 'Hayao Miyazaki', ['Rumi Hiiragi', 'Miyu Irino'], ['Animation', 'Fantasy'], 'Japanese', 'PG', 2001, 8.6, 'Female', 125, 58).
movie('Grave of the Fireflies', 'Isao Takahata', ['Tsutomu Tatsumi', 'Ayano Shiraishi'], ['Animation', 'War'], 'Japanese', 'PG', 1988, 8.5, 'Both', 89, 0).
movie('Akira', 'Katsuhiro Otomo', ['Mitsuo Iwata', 'Nozomu Sasaki'], ['Animation', 'Sci-Fi'], 'Japanese', 'R', 1988, 8.0, 'Male', 124, 1).
movie('V for Vendetta', 'James McTeigue', ['Hugo Weaving', 'Natalie Portman'], ['Action', 'Drama'], 'English', 'R', 2005, 8.2, 'Both', 132, 7).
movie('Shutter Island', 'Martin Scorsese', ['Leonardo DiCaprio', 'Mark Ruffalo'], ['Mystery', 'Thriller'], 'English', 'R', 2010, 8.2, 'Male', 138, 11).
movie('Prisoners', 'Denis Villeneuve', ['Hugh Jackman', 'Jake Gyllenhaal'], ['Crime', 'Drama'], 'English', 'R', 2013, 8.1, 'Male', 153, 10).
movie('The Wolf of Wall Street', 'Martin Scorsese', ['Leonardo DiCaprio', 'Jonah Hill'], ['Biography', 'Comedy'], 'English', 'R', 2013, 8.2, 'Male', 180, 38).
movie('War of the Worlds', 'Steven Spielberg', ['Tom Cruise', 'Dakota Fanning'], ['Action', 'Adventure'], 'English', 'PG-13', 2005, 6.5, 'Male', 116, 16).
movie('Ratatouille', 'Brad Bird', ['Patton Oswalt', 'Lou Romano'], ['Animation', 'Comedy'], 'English', 'G', 2007, 8.0, 'Male', 111, 68).
movie('Titanic', 'James Cameron', ['Leonardo DiCaprio', 'Kate Winslet'], ['Drama', 'Romance'], 'English', 'PG-13', 1997, 7.8, 'Both', 195, 126).
movie('Blade Runner 2049', 'Denis Villeneuve', ['Ryan Gosling', 'Harrison Ford'], ['Drama', 'Mystery'], 'English', 'R', 2017, 8.0, 'Male', 164, 100).
movie('House of Flying Daggers', 'Zhang Yimou', ['Takeshi Kaneshiro', 'Andy Lau'], ['Action', 'Drama'], 'Chinese', 'R', 2004, 7.5, 'Both', 119, 26).
movie('Hero', 'Zhang Yimou', ['Jet Li', 'Tony Leung Chiu Wai'], ['Action', 'Drama'], 'Chinese', 'PG-13', 2002, 7.9, 'Male', 107, 46).
movie('Pan\'s Labyrinth', 'Guillermo del Toro', ['Ivana Baquero', 'Sergi Lopez'], ['Fantasy', 'Drama'], 'Spanish', 'R', 2006, 8.2, 'Female', 118, 109).
movie('The Secret in Their Eyes', 'Juan Jose Campanella', ['Ricardo Darin', 'Soledad Villamil'], ['Drama', 'Mystery'], 'Spanish', 'R', 2009, 8.2, 'Male', 129, 53).
movie('I want to Eat Your Pancreas', 'Shinichiro Ushijima', ['Mahiro Takasugi', 'Tsubasa Honda'], ['Animation', 'Drama'], 'Japanese', 'PG-13', 2018, 8.6, 'Female', 109, 2).
movie('Assal Eswed', 'Khaled Marei', ['Ahmed Helmy', 'Edward'], ['Comedy', 'Drama'], 'Arabic', 'G', 2010, 8.0, 'Male', 130, 1).
movie('Sa\'eedi fil gamaa el amrekeia', 'Said Hamed', ['Mohamed Henedy', 'Ahmed ElSakka'], ['Comedy', 'Drama'], 'Arabic', 'PG', 1998, 7.0, 'Male', 118, 0).
movie('El-Limby', 'Wael Ihsan', ['Mohamed Saad', 'Abla Kamel'], ['Comedy'], 'Arabic', 'PG', 2002, 6.5, 'Male', 89, 1).
movie('Mallaki Iskandariya', 'Sandra Nashaat', ['Ahmed Ezz','Ghadah Adel'], ['Crime', 'Drama'], 'Arabic', 'PG', 2005, 7.2, 'Male', 95, 0).
movie('Masgoon Tranzait', 'Sandra Nashaat', ['Ahmed Ezz', 'Nour ElSherif'], ['Adventure', 'Drama'], 'Arabic', 'PG-13', 2008, 6.5, 'Male', 116, 0).
movie('El-Khaliyyah', 'Tarek Alarian', ['Ahmed Ezz', 'Mohamed Mamdouh'], ['Action', 'Drama'], 'Arabic', 'PG-13', 2017, 6.3, 'Male', 126, 0).
movie('El-Basha Tilmeez', 'Wael Ihsan', ['Hassan Hosny','Ghadah Adel','Karim Abdel Aziz'], ['Comedy', 'Action'], 'Arabic', 'PG', 2004, 6.4, 'Male', 110, 0).
movie('Tattah', 'Sameh Abdulaziz', ['Mohamed Saad', 'Omar Metwally'], ['Comedy', 'Drama'], 'Arabic', 'PG', 2013, 4.4, 'Male', 115, 0).
movie('El-Limbi 8 Giga', 'Ashraf Fayeq', ['Mohamed Saad', 'Mai Ezz Eldin'], ['Comedy', 'Drama'], 'Arabic', 'PG', 2010, 5.1, 'Male', 111, 0).
movie('THE BeeKeeper', 'David Ayer', ['Jason Statham', 'Jessica Alba'], ['Action', 'Thriller'], 'English', 'R', 2024, 6.3, 'Male', 105, 0).
movie('Taxi Driver', 'Martin Scorsese', ['Robert De Niro', 'Jodie Foster'], ['Drama', 'Crime'], 'English', 'R', 1976, 8.2, 'Male', 114, 22).
movie('Lucy', 'Luc Besson', ['Scarlett Johansson', 'Morgan Freeman','Amr Waked'], ['Action', 'Sci-Fi'], 'English', 'R', 2014, 6.4, 'Female', 89, 1).
movie('Cast Away', 'Robert Zemeckis', ['Tom Hanks', 'Helen Hunt'], ['Drama', 'Adventure'], 'English', 'PG-13', 2000, 7.8, 'Male', 143, 15).
movie('Unknown', 'Jaume Collet Serra', ['Liam Neeson', 'Diane Kruger'], ['Action', 'Thriller'], 'English', 'PG-13', 2011, 6.8, 'Male', 113, 0).
movie('Snatch', 'Guy Ritchie', ['Jason Statham', 'Brad Pitt'], ['Comedy', 'Crime'], 'English', 'R', 2000, 8.2, 'Male', 104, 4).
movie('Speed', 'Jan de Bont', ['Keanu Reeves', 'Sandra Bullock'], ['Action', 'Thriller'], 'English', 'R', 1994, 7.2, 'Male', 116, 20).
movie('The Irishman', 'Martin Scorsese', ['Robert De Niro', 'Al Pacino'], ['Biography', 'Crime'], 'English', 'R', 2019, 7.8, 'Male', 209, 73).
movie('Joker', 'Todd Phillips', ['Joaquin Phoenix', 'Robert De Niro'], ['Crime', 'Drama'], 'English', 'R', 2019, 8.3, 'Male', 122, 121).
movie('Logan', 'James Mangold', ['Hugh Jackman', 'Patrick Stewart'], ['Action', 'Drama'], 'English', 'R', 2017, 8.1, 'Male', 137, 28).
movie('The Adam Project', 'Shawn Levy', ['Ryan Reynolds', 'Mark Ruffalo'], ['Action', 'Adventure'], 'English', 'PG-13', 2022, 6.7, 'Male', 106, 1).
movie('Red Notice', 'Rawson Marshall Thurber', ['Dwayne Johnson', 'Ryan Reynolds'], ['Action', 'Comedy'], 'English', 'PG-13', 2021, 6.3, 'Male', 117, 0).
movie('6 Underground', 'Michael Bay', ['Ryan Reynolds', 'Melanie Laurent'], ['Action', 'Adventure'], 'English', 'R', 2019, 6.1, 'Male', 128, 1).

% --- Dynamic storage for user preferences ---
:- dynamic(asked/3).

ask_pref(director, Director) :-
    write('What is your favorite director? '),
    read(Director),
    assert(asked(user, director, Director)).

ask_pref(actors, Actors) :-
    write('Who are your favorite actors? (Enter as list [actor1, actor2] or single actor) '),
    read(Actors),
    assert(asked(user, actors, Actors)).

ask_pref(genre, Genre) :-
    write('What are your favorite genres? (Enter as list [genre1, genre2] or single genre) '),
    read(Genre),
    assert(asked(user, genre, Genre)).

ask_pref(language, Language) :-
    write('What is your preferred language? '),
    read(Language),
    assert(asked(user, language, Language)).

ask_pref(age_rating, AgeRating) :-
    write('What is your preferred age rating? (G, PG, PG-13, R) '),
    read(AgeRating),
    assert(asked(user, age_rating, AgeRating)).

ask_pref(year, Year) :-
    write('What is your preferred release year? (Enter a number) '),
    read(YearInput),
    (number(YearInput) -> 
        Year = YearInput ; 
        write('Invalid year. Using 2000 as default.'), nl, Year = 2000),
    assert(asked(user, year, Year)).

ask_pref(imdb_rate, IMDBRate) :-
    write('What is your minimum IMDB rating? (1-10) '),
    read(RatingInput),
    (number(RatingInput) -> 
        IMDBRate = RatingInput ; 
        write('Invalid rating. Using 7.0 as default.'), nl, IMDBRate = 7.0),
    assert(asked(user, imdb_rate, IMDBRate)).

% --- Rules ---
ask() :-
    ask_pref(director, _),
    ask_pref(actors, _),
    ask_pref(genre, _),
    ask_pref(language, _),
    ask_pref(age_rating, _),
    ask_pref(year, _),
    ask_pref(imdb_rate, _).

% use partial matches with a scoring system and handle skipped attributes
likes_movie(Movie, Score) :-
    movie(Movie, Director, Actors, Genre, Language, AgeRating, Year, IMDBRate, LeadGender, Duration, AwardsWon),
    (asked(user, director, UserDirector) -> true ; UserDirector = ''),
    (asked(user, actors, UserActors) -> true ; UserActors = []),
    (asked(user, genre, UserGenre) -> true ; UserGenre = []),
    (asked(user, language, UserLanguage) -> true ; UserLanguage = ''),
    (asked(user, age_rating, UserRating) -> true ; UserRating = ''),
    (asked(user, year, UserYear) -> true ; UserYear = 2000),
    (asked(user, imdb_rate, UserIMDB) -> true ; UserIMDB = 7.0),
    (asked(user, lead_gender, UserLeadGender) -> true ; UserLeadGender = ''),
    (asked(user, min_duration, UserMinDuration) -> true ; UserMinDuration = 0),
    (asked(user, max_duration, UserMaxDuration) -> true ; UserMaxDuration = 999),
    (asked(user, awards, UserAwards) -> true ; UserAwards = 0),

    (UserDirector == '' -> DirectorScore = 1 ; 
     UserDirector == Director -> DirectorScore = 1 ; 
     DirectorScore = 0),
    
    (UserActors == [] ; UserActors == '' -> ActorScore = 2 ; 
     actors_match(UserActors, Actors) -> ActorScore = 2 ; 
     ActorScore = 0),

    (UserGenre == [] ; UserGenre == '' -> GenreScore = 3 ; 
     genre_match(UserGenre, Genre) -> GenreScore = 3 ; 
     GenreScore = 0),

    (UserLanguage == '' -> LanguageScore = 1 ; 
     UserLanguage == Language -> LanguageScore = 1 ; 
     LanguageScore = -5),

    (UserRating == '' -> RatingScore = 1 ; 
     UserRating == AgeRating -> RatingScore = 1 ; 
     RatingScore = 0),

    (abs(UserYear - Year) =< 10 -> YearScore = 1 ;
     YearScore = 0),

    (IMDBRate >= UserIMDB -> IMDBScore = 1 ; 
     IMDBScore = -5),
     
    (UserLeadGender == '' -> LeadGenderScore = 1 ;
     UserLeadGender == LeadGender -> LeadGenderScore = 1 ;
     UserLeadGender == 'Both' -> LeadGenderScore = 1 ;
     LeadGenderScore = 0),
     
    (Duration >= UserMinDuration, Duration =< UserMaxDuration -> DurationScore = 1 ;
     DurationScore = -2),
     
    (AwardsWon >= UserAwards -> AwardsScore = 1 ;
     AwardsScore = 0),

    Score is DirectorScore + ActorScore + GenreScore + LanguageScore + RatingScore + YearScore 
           + IMDBScore + LeadGenderScore + DurationScore + AwardsScore,
    Score >= 5. % Minimum score to recommend a movie

% Safer helper predicates
actors_match(UserActors, MovieActors) :-
    (UserActors = [] -> fail ;
     is_list(UserActors) -> 
        member(Actor, UserActors), member(Actor, MovieActors) ; 
        member(UserActors, MovieActors)).

genre_match(UserGenre, MovieGenre) :-
    (UserGenre = [] -> fail ;
     is_list(UserGenre) -> 
        member(GenreItem, UserGenre), member(GenreItem, MovieGenre) ; 
        member(UserGenre, MovieGenre)).
    

% --- Main predicate ---
recommend :-
    retractall(asked(_, _, _)),
    write('Welcome to the Movie Recommender!'), nl,
    write('Please answer the following questions to get your movie recommendations write \'\' to skip this question.'), nl,
    write('For actors and genres, you can enter a list like [actor1, actor2]'), nl,
    ask(),
    write('Here are your recommended movies:'), nl,
    findall(Movie-Score, likes_movie(Movie, Score), ScoredMovies),
    sort(2, @>=, ScoredMovies, SortedMovies),
    (SortedMovies = [] -> 
        write('No movies found matching your preferences.') ;
        write_movies(SortedMovies)
    ).
    
% Helper predicate to display movies list with scores
write_movies([]) :- !.
write_movies([Movie-Score|Rest]) :-
    write('- '), write(Movie), write(' (match score: '), write(Score), write(')'), nl,
    write_movies(Rest).

% display_movie(MovieName) - Shows all information about a specific movie
display_movie(MovieName) :-
    movie(MovieName, Director, Actors, Genres, Language, AgeRating, Year, IMDBRate, LeadGender, Duration, AwardsWon),
    nl,
    write('Title: '), write(MovieName),nl,
    write('Director: '), write(Director),nl,
    write('Actors: '), write_list(Actors),nl,
    write('Genres: '), write_list(Genres),nl,
    write('Language: '), write(Language),nl,
    write('Age Rating: '), write(AgeRating),nl,
    write('Release Year: '), write(Year),nl,
    write('IMDB Rating: '), write(IMDBRate),nl,
    write('Lead Gender: '), write(LeadGender),nl,
    write('Duration: '), write(Duration),nl,
    write('Awards Won: '), write(AwardsWon),
    nl.

% Helper predicate to display lists neatly
write_list([]) :- !.
write_list([Item]) :- write(Item), !.
write_list([Item|Rest]) :-
    write(Item), write(', '),
    write_list(Rest).



% get_distinct_values(Field, Values) - Gets all distinct values for a given field
get_distinct_values(Field, Values) :-
    findall(Value, get_value_for_field(Field, Value), AllValues),
    sort(AllValues, Values).  % sort removes duplicates

% Helper predicate to extract a value for a specific field
get_value_for_field(director, Director) :-
    movie(_, Director, _, _, _, _, _, _, _, _, _).

get_value_for_field(actor, Actor) :-
    movie(_, _, ActorsList, _, _, _, _, _, _, _, _),
    member(Actor, ActorsList).

get_value_for_field(genre, Genre) :-
    movie(_, _, _, GenresList, _, _, _, _, _, _, _),
    member(Genre, GenresList).

get_value_for_field(language, Language) :-
    movie(_, _, _, _, Language, _, _, _, _, _, _).

get_value_for_field(age_rating, AgeRating) :-
    movie(_, _, _, _, _, AgeRating, _, _, _, _, _).

get_value_for_field(year, Year) :-
    movie(_, _, _, _, _, _, Year, _, _, _, _).

get_value_for_field(lead_gender, LeadGender) :-
    movie(_, _, _, _, _, _, _, _, LeadGender, _, _).

get_value_for_field(duration, Duration) :-
    movie(_, _, _, _, _, _, _, _, _, Duration, _).

get_value_for_field(awards, Awards) :-
    movie(_, _, _, _, _, _, _, _, _, _, Awards).


