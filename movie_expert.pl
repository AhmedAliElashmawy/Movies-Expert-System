% --- Facts ---

% movie(Name,Director,Actors, Genre, Language, AgeRating, Year, IMDBrate).
movie('The Shawshank Redemption', 'Frank Darabont', ['Tim Robbins', 'Morgan Freeman'], ['Drama', 'Crime'], 'English', 'R', 1994, 9).
movie('Schindler\'s List', 'Steven Spielberg', ['Liam Neeson', 'Ben Kingsley'], ['Biography', 'History'], 'English', 'R', 1993, 8.9).
movie('Forrest Gump', 'Robert Zemeckis', ['Tom Hanks', 'Robin Wright'], ['Drama', 'Comedy'], 'English', 'PG-13', 1994, 8.8).
movie('Inception', 'Christopher Nolan', ['Leonardo DiCaprio', 'Joseph Gordon-Levitt'], ['Action', 'Sci-Fi'], 'English', 'PG-13', 2010, 8.8).
movie('Fight Club', 'David Fincher', ['Brad Pitt', 'Edward Norton'], ['Drama', 'Thriller'], 'English', 'R', 1999, 8.8).
movie('The Matrix', 'Lana Wachowski', ['Keanu Reeves', 'Laurence Fishburne'], ['Action', 'Sci-Fi'], 'English', 'R', 1999, 8.7).
movie('Goodfellas', 'Martin Scorsese', ['Ray Liotta', 'Robert De Niro'], ['Crime', 'Biography'], 'English', 'R', 1990, 8.7).
movie('Saving Private Ryan', 'Steven Spielberg', ['Tom Hanks', 'Matt Damon'], ['Drama', 'War'], 'English', 'R', 1998, 8.6).
movie('The Usual Suspects', 'Bryan Singer', ['Kevin Spacey', 'Gabriel Byrne'], ['Crime', 'Mystery'], 'English', 'R', 1995, 8.5).
movie('Se7en', 'David Fincher', ['Morgan Freeman', 'Brad Pitt'], ['Crime', 'Thriller'], 'English', 'R', 1995, 8.6).
movie('Interstellar', 'Christopher Nolan', ['Matthew McConaughey', 'Anne Hathaway'], ['Adventure', 'Sci-Fi'], 'English', 'PG-13', 2014, 8.6).
movie('The Departed', 'Martin Scorsese', ['Leonardo DiCaprio', 'Matt Damon'], ['Crime', 'Thriller'], 'English', 'R', 2006, 8.5).
movie('The Prestige', 'Christopher Nolan', ['Hugh Jackman', 'Christian Bale'], ['Drama', 'Mystery'], 'English', 'PG-13', 2006, 8.5).
movie('The Lion King', 'Roger Allers', ['Matthew Broderick', 'James Earl Jones'], ['Animation', 'Adventure'], 'English', 'G', 1994, 8.5).
movie('Django Unchained', 'Quentin Tarantino', ['Jamie Foxx', 'Christoph Waltz'], ['Western', 'Drama'], 'English', 'R', 2012, 8.4).
movie('Collateral', 'Michael Mann', ['Tom Cruise', 'Jamie Foxx'], ['Action', 'Thriller'], 'English', 'R', 2004, 7.5).
movie('Edge of Tomorrow', 'Doug Liman', ['Tom Cruise', 'Emily Blunt'], ['Action', 'Sci-Fi'], 'English', 'PG-13', 2014, 7.9).
movie('Wall-E', 'Andrew Stanton', ['Ben Burtt', 'Elissa Knight'], ['Animation', 'Adventure'], 'English', 'G', 2008, 8.4).
movie('Your Name', 'Makoto Shinkai', ['Ryunosuke Kamiki', 'Mone Kamishiraishi'], ['Animation', 'Romance'], 'Japanese', 'PG', 2016, 8.9).
movie('Spirited Away', 'Hayao Miyazaki', ['Rumi Hiiragi', 'Miyu Irino'], ['Animation', 'Fantasy'], 'Japanese', 'PG', 2001, 8.6).
movie('Grave of the Fireflies', 'Isao Takahata', ['Tsutomu Tatsumi', 'Ayano Shiraishi'], ['Animation', 'War'], 'Japanese', 'PG', 1988, 8.5).
movie('Akira', 'Katsuhiro Otomo', ['Mitsuo Iwata', 'Nozomu Sasaki'], ['Animation', 'Sci-Fi'], 'Japanese', 'R', 1988, 8.0).
movie('V for Vendetta', 'James McTeigue', ['Hugo Weaving', 'Natalie Portman'], ['Action', 'Drama'], 'English', 'R', 2005, 8.2).
movie('Shutter Island', 'Martin Scorsese', ['Leonardo DiCaprio', 'Mark Ruffalo'], ['Mystery', 'Thriller'], 'English', 'R', 2010, 8.2).
movie('Prisoners', 'Denis Villeneuve', ['Hugh Jackman', 'Jake Gyllenhaal'], ['Crime', 'Drama'], 'English', 'R', 2013, 8.1).
movie('The Wolf of Wall Street', 'Martin Scorsese', ['Leonardo DiCaprio', 'Jonah Hill'], ['Biography', 'Comedy'], 'English', 'R', 2013, 8.2).
movie('War of the Worlds', 'Steven Spielberg', ['Tom Cruise', 'Dakota Fanning'], ['Action', 'Adventure'], 'English', 'PG-13', 2005, 6.5).
movie('Ratatouille', 'Brad Bird', ['Patton Oswalt', 'Lou Romano'], ['Animation', 'Comedy'], 'English', 'G', 2007, 8.0).
movie('Titanic', 'James Cameron', ['Leonardo DiCaprio', 'Kate Winslet'], ['Drama', 'Romance'], 'English', 'PG-13', 1997, 7.8).
movie('Blade Runner 2049', 'Denis Villeneuve', ['Ryan Gosling', 'Harrison Ford'], ['Drama', 'Mystery'], 'English', 'R', 2017, 8.0).
movie('House of Flying Daggers', 'Zhang Yimou', ['Takeshi Kaneshiro', 'Andy Lau'], ['Action', 'Drama'], 'Chinese', 'R', 2004, 7.5).
movie('Hero', 'Zhang Yimou', ['Jet Li', 'Tony Leung Chiu Wai'], ['Action', 'Drama'], 'Chinese', 'PG-13', 2002, 7.9).
movie('Pan\'s Labyrinth', 'Guillermo del Toro', ['Ivana Baquero', 'Sergi López'], ['Fantasy', 'Drama'], 'Spanish', 'R', 2006, 8.2).
movie('The Secret in Their Eyes', 'Juan José Campanella', ['Ricardo Darín', 'Soledad Villamil'], ['Drama', 'Mystery'], 'Spanish', 'R', 2009, 8.2).
movie('I want to Eat Your Pancreas', 'Shinichirō Ushijima', ['Mahiro Takasugi', 'Tsubasa Honda'], ['Animation', 'Drama'], 'Japanese', 'PG-13', 2018, 8.6).
movie('Asal Eswed', 'Sameh Abdulaziz', ['Ahmed Helmy', 'Nelly Karim'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2010, 7.5).
movie('Saeidi fe ElGamaah  ElAmriciyah', 'Said Hamed', ['Mohamed Henedy', 'Ahmed El-Sakka'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 1998, 7.5).
movie('El-Limby', 'Sherif Arafa', ['Mohamed Saad', 'Ola Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2002, 7.5).
movie('Malaki Eskenderia', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2005, 7.5).
movie('Masgoon Transit', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2007, 7.5).
movie('El-Khalia', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2008, 7.5).
movie('El-Basha Telmiz', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2009, 7.5).
movie('Tatah', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2010, 7.5).
movie('El-Limby 8 Giga', 'Ismail Farouk', ['Mohamed Saad', 'Donia Samir Ghanem'], ['Comedy', 'Drama'], 'Arabic', 'PG-13', 2011, 7.5).

% --- Dynamic storage for user preferences ---
:- dynamic(asked/3).

ask_pref(director, Director) :-
    write('What is your favorite director? '),
    read(Director),
    assert(asked(user, director, Director)).

ask_pref(actors, Actors) :-
    write('What are your favorite actors? '),
    read(Actors),
    assert(asked(user, actors, Actors)).
ask_pref(genre, Genre) :-
    write('What is your favorite genre? '),
    read(Genre),
    assert(asked(user, genre, Genre)).
ask_pref(language, Language) :- 
    write('What is your favorite language? '),
    read(Language),
    assert(asked(user, language, Language)).
ask_pref(age_rating, AgeRating) :-
    write('What is your favorite age rating? '),
    read(AgeRating),
    assert(asked(user, age_rating, AgeRating)).
ask_pref(year, Year) :-
    write('What is your favorite year? '),
    read(Year),
    assert(asked(user, year, Year)).
ask_pref(imdb_rate, IMDBRate) :-
    write('What is your favorite IMDB rating? '),
    read(IMDBRate),
    assert(asked(user, imdb_rate, IMDBRate)).

% --- Rules ---
ask() :-
    ask_pref(director, _),
    ask_pref(actors, _),
    ask_pref(genre, _),
    ask_pref(language, _),
    ask_pref(age_rating, _),
    ask_pref(year, _),
    ask_pref(imdb_rate, _).

% Modified to use partial matches with a scoring system
likes_movie(User, Movie, Score) :-
    movie(Movie, Director, Actors, Genre, Language, AgeRating, Year, IMDBRate),
    Score is 0
        + (asked(User, director, Director) -> 3 ; 0)
        + (member_match(User, actors, Actors) -> 2 ; 0)
        + (member_match(User, genre, Genre) -> 2 ; 0)
        + (asked(User, language, Language) -> 1 ; 0)
        + (asked(User, age_rating, AgeRating) -> 1 ; 0)
        + (year_close(User, Year) -> 1 ; 0)
        + (rating_close(User, IMDBRate) -> 1 ; 0),
    Score > 2. % At least some matches

% Helper predicates
member_match(User, Type, List) :-
    asked(User, Type, UserPref),
    (is_list(UserPref) -> 
        (member(Item, UserPref), member(Item, List)) ; 
        member(UserPref, List)).

year_close(User, Year) :-
    asked(User, year, UserYear),
    abs(UserYear - Year) =< 3.

rating_close(User, Rating) :-
    asked(User, imdb_rate, UserRating),
    abs(UserRating - Rating) =< 1.

% --- Main predicate ---
recommind :-
    retractall(asked(_, _, _)), % Clear previous preferences
    write('Welcome to the Movie Recommender!'), nl,
    write('Please answer the following questions to get your movie recommendations.'), nl,
    write('For actors and genres, you can enter a list like [actor1, actor2] or [genre1, genre2]'), nl,
    ask(),
    write('Here are your recommended movies:'), nl,
    findall(Movie-Score, likes_movie(user, Movie, Score), ScoredMovies),
    sort(2, @>=, ScoredMovies, SortedMovies),
    (SortedMovies = [] -> write('No movies found matching your preferences.') ;
        write_movies(SortedMovies)).
    
% Helper predicate to display movies list with scores
write_movies([]) :- !.
write_movies([Movie-Score|Rest]) :-
    write('- '), write(Movie), write(' (match score: '), write(Score), write(')'), nl,
    write_movies(Rest).


